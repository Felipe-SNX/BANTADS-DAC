services:

    api-gateway:
      build:
        context: ./api-gateway
      container_name: api-gateway
      ports:
        - "3000:3000"
      environment:
        PORT: 3000
        MS_CONTA_URL: http://ms-conta:8090
        MS_GERENTE_URL: http://ms-gerente:8091
      depends_on:
        ms-conta:
          condition: service_healthy
        ms-gerente:
          condition: service_healthy

    rabbitmq:
      image: rabbitmq:4-management
      container_name: rabbitmq
      restart: always
      ports:
        - 5672:5672
        - 15672:15672
      volumes:
        - ./dadosrabbit:/var/lib/rabbitmq
      environment:
        - RABBITMQ_DEFAULT_USER=admin
        - RABBITMQ_DEFAULT_PASS=123456
      healthcheck:
        test: [ "CMD", "rabbitmq-diagnostics", "check_running" ]
        interval: 5s
        timeout: 5s
        retries: 10

    bantads-db:
      image: postgres:latest
      container_name: bantads-db
      environment:
        - POSTGRES_DB=bantads-db
        - POSTGRES_USER=postgres
        - POSTGRES_PASSWORD=postgres
      ports:
        - 5436:5432
      volumes:
        - ./init-db:/docker-entrypoint-initdb.d
      healthcheck:
        test: [ "CMD-SHELL", "pg_isready -U postgres -d bantads-db" ]
        interval: 5s
        timeout: 5s
        retries: 5

    ms-conta:
      build: './ms-conta'
      container_name: ms-conta
      depends_on:
        bantads-db:
          condition: service_healthy
        rabbitmq:
          condition: service_healthy
      ports:
        - 8090:8090
      environment:
        - SPRING_DATASOURCE_URL=jdbc:postgresql://bantads-db:5432/bantads-db
        - SPRING_DATASOURCE_USERNAME=postgres
        - SPRING_DATASOURCE_PASSWORD=postgres
        - SPRING_RABBITMQ_HOST=rabbitmq
        - SPRING_RABBITMQ_USERNAME=admin
        - SPRING_RABBITMQ_PASSWORD=123456
      healthcheck:
        test: [ "CMD", "curl", "-f", "http://localhost:8090/actuator/health" ]
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 30s

    ms-gerente:
      build: './ms-gerente'
      container_name: ms-gerente
      depends_on:
        bantads-db:
          condition: service_healthy
        rabbitmq:
          condition: service_healthy
      ports:
        - 8091:8091
      environment:
        - SPRING_DATASOURCE_URL=jdbc:postgresql://bantads-db:5432/bantads-db
        - SPRING_DATASOURCE_USERNAME=postgres
        - SPRING_DATASOURCE_PASSWORD=postgres
        - SPRING_RABBITMQ_HOST=rabbitmq
        - SPRING_RABBITMQ_USERNAME=admin
        - SPRING_RABBITMQ_PASSWORD=123456
      healthcheck:
        test: [ "CMD", "curl", "-f", "http://localhost:8091/actuator/health" ]
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 30s